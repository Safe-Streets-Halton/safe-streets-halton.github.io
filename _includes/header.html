<header class="site-header" role="banner">
    <div class="header-content relative">
        {%- assign default_paths = site.pages | sort: 'position' | map: "path" -%}
        {%- assign page_paths = site.header_pages | default: default_paths -%}
        <a href="/"><img alt="Safe Streets Halton Logo" src="/assets/Social_Avatar_512x512.png" class="header-logo" /></a>
        <nav class="site-nav">            
            <input type="checkbox" id="site-nav__trigger" class="site-nav__trigger" />
            <label for="site-nav__trigger">
                <span class="site-nav__menu-icon">                    
                </span>
            </label>        
            <div class="site-nav__links">
                                {%- for item in page_paths -%}
                                        {%- comment -%}
                                            Support two shapes for header_pages:
                                            - a string path (legacy) or
                                            - an object with `url` and optional `dropdown` array
                                        {%- endcomment -%}
                                        {%- if item.url -%}
                                            {%- assign page_path = item.url -%}
                                        {%- else -%}
                                            {%- assign page_path = item -%}
                                        {%- endif -%}
                                                            {%- assign my_page = site.pages | where: "url", page_path | first -%}
                                                            {%- if my_page == nil -%}
                                                                {%- assign page_path_slash = page_path | append: '/' -%}
                                                                {%- assign my_page = site.pages | where: "url", page_path_slash | first -%}
                                                            {%- endif -%}
                                        {%- if my_page.title and my_page.url != "/" and my_page.hidden != true -%}
                                            {%- if item.dropdown -%}
                                                <div class="nav-item nav-item--has-dropdown">
                                                    <div class="nav-dropdown-title-container">
                                                        <a class="page-link" href="{{ my_page.url | relative_url }}">{{ my_page.title | escape }}</a>
                                                        <button class="dropdown-toggle" 
                                                                id="dropdown-toggle-{{ forloop.index }}"
                                                                aria-expanded="false" 
                                                                aria-controls="dropdown-{{ forloop.index }}" 
                                                                aria-haspopup="menu"
                                                                aria-label="Toggle {{ my_page.title | escape }} submenu">
                                                            <span class="caret" aria-hidden="true">â–¾</span>
                                                            <span class="visually-hidden">Toggle submenu</span>
                                                        </button>
                                                    </div>
                                                    <ul id="dropdown-{{ forloop.index }}" class="dropdown-menu" role="menu" aria-labelledby="dropdown-toggle-{{ forloop.index }}">
                                                        {%- for sub in item.dropdown -%}
                                                            <li role="none"><a role="menuitem" class="dropdown-link" href="{{ sub.url | relative_url }}" tabindex="-1">{{ sub.title | escape }}</a></li>
                                                        {%- endfor -%}
                                                    </ul>
                                                </div>
                                            {%- else -%}
                                                <a class="page-link" href="{{ my_page.url | relative_url }}">{{ my_page.title | escape }}</a>
                                            {%- endif -%}
                                        {%- endif -%}
                                {%- endfor -%}
                {%- include social.html -%}      
            </div>            
        </nav>
    </div>    
</header>
{%- if site.announcement and site.announcement.show -%}
    <section class="announcement-banner {{ site.announcement.danger_level }}">
        <div class="announcement-banner__content">
            <div class="announcement-banner__icon">{{site.announcement.icon}}</div>
            <p class="announcement-banner__text">{{site.announcement.text}}</p>
            <button class="button button--light-transparent-white announcement-banner__action" onclick="window.location.href='{{site.announcement.link}}'">{{site.announcement.action}}</button>
        </div>
    </section>
{%- endif -%}

<script>
// Accessible dropdown menu implementation following WCAG 2.0 guidelines
(function() {
    'use strict';
    
    if (!document) return;
    
    let currentOpenDropdown = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        const dropdownButtons = document.querySelectorAll('.dropdown-toggle');
        
        dropdownButtons.forEach(function(button) {
            const parent = button.closest('.nav-item--has-dropdown');
            const menu = parent ? parent.querySelector('.dropdown-menu') : null;
            const menuItems = menu ? menu.querySelectorAll('a[role="menuitem"]') : [];
            
            if (!parent || !menu) return;
            
            // Button click handler
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const isExpanded = button.getAttribute('aria-expanded') === 'true';
                
                // Close any open dropdown
                if (currentOpenDropdown && currentOpenDropdown !== button) {
                    closeDropdown(currentOpenDropdown);
                }
                
                if (isExpanded) {
                    closeDropdown(button);
                } else {
                    openDropdownMenu(button);
                }
            });
            
            // Keyboard navigation for button
            button.addEventListener('keydown', function(e) {
                switch (e.key) {
                    case 'Enter':
                    case ' ':
                    case 'ArrowDown':
                        e.preventDefault();
                        openDropdownMenu(button);
                        if (menuItems.length > 0) {
                            menuItems[0].focus();
                        }
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        openDropdownMenu(button);
                        if (menuItems.length > 0) {
                            menuItems[menuItems.length - 1].focus();
                        }
                        break;
                    case 'Escape':
                        if (button.getAttribute('aria-expanded') === 'true') {
                            closeDropdown(button);
                        }
                        break;
                }
            });
            
            // Keyboard navigation for menu items
            menuItems.forEach(function(item, index) {
                item.addEventListener('keydown', function(e) {
                    switch (e.key) {
                        case 'ArrowDown':
                            e.preventDefault();
                            const nextIndex = (index + 1) % menuItems.length;
                            menuItems[nextIndex].focus();
                            break;
                        case 'ArrowUp':
                            e.preventDefault();
                            const prevIndex = index === 0 ? menuItems.length - 1 : index - 1;
                            menuItems[prevIndex].focus();
                            break;
                        case 'Home':
                            e.preventDefault();
                            menuItems[0].focus();
                            break;
                        case 'End':
                            e.preventDefault();
                            menuItems[menuItems.length - 1].focus();
                            break;
                        case 'Escape':
                            e.preventDefault();
                            closeDropdown(button);
                            button.focus();
                            break;
                        case 'Tab':
                            // Allow tab to move to next focusable element, but close dropdown
                            closeDropdown(button);
                            break;
                    }
                });
            });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (currentOpenDropdown && !e.target.closest('.nav-item--has-dropdown')) {
                closeDropdown(currentOpenDropdown);
            }
        });
        
        // Close dropdown on escape key globally
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && currentOpenDropdown) {
                closeDropdown(currentOpenDropdown);
                currentOpenDropdown.focus();
            }
        });
        
        // Update dropdown state on window resize
        function updateDropdownState() {
            const isMobile = window.innerWidth <= 800;
            
            dropdownButtons.forEach(function(button) {
                const parent = button.closest('.nav-item--has-dropdown');
                const menu = parent ? parent.querySelector('.dropdown-menu') : null;
                
                if (isMobile) {
                    // Mobile: Ensure button is interactive
                    button.disabled = false;
                    button.style.pointerEvents = '';
                    button.tabIndex = 0;
                    button.removeAttribute('aria-hidden');
                } else {
                    // Desktop: Dropdown works on hover, but keyboard navigation still works
                    button.disabled = false;
                    button.style.pointerEvents = '';
                    button.tabIndex = 0;
                    button.removeAttribute('aria-hidden');
                    
                    // Close any open dropdowns when switching to desktop
                    if (button.getAttribute('aria-expanded') === 'true') {
                        closeDropdown(button);
                    }
                }
            });
        }
        
        function openDropdownMenu(button) {
            const parent = button.closest('.nav-item--has-dropdown');
            const menu = parent ? parent.querySelector('.dropdown-menu') : null;
            const menuItems = menu ? menu.querySelectorAll('a[role="menuitem"]') : [];
            
            if (!parent || !menu) return;
            
            button.setAttribute('aria-expanded', 'true');
            parent.classList.add('dropdown-open');
            menu.style.display = 'block';
            
            // Set tabindex for menu items
            menuItems.forEach(function(item) {
                item.tabIndex = 0;
            });
            
            currentOpenDropdown = button;
        }
        
        function closeDropdown(button) {
            const parent = button.closest('.nav-item--has-dropdown');
            const menu = parent ? parent.querySelector('.dropdown-menu') : null;
            const menuItems = menu ? menu.querySelectorAll('a[role="menuitem"]') : [];
            
            if (!parent || !menu) return;
            
            button.setAttribute('aria-expanded', 'false');
            parent.classList.remove('dropdown-open');
            menu.style.display = 'none';
            
            // Remove tabindex from menu items when closed
            menuItems.forEach(function(item) {
                item.tabIndex = -1;
            });
            
            if (currentOpenDropdown === button) {
                currentOpenDropdown = null;
            }
        }
        
        // Initialize state
        updateDropdownState();
        window.addEventListener('resize', updateDropdownState);
    });
})();
</script>
